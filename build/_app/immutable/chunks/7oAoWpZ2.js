import{b as v}from"./K6YgHZ2F.js";class S{async getFichaComplete(o){var e,d,a,s,E,g,q,h,y,m,A,D,C,U,F;console.log("ğŸ“‹ FichaQueryAdapter: Buscando dados da ficha via endpoints especÃ­ficos:",o);try{const i=await v.get(`/fichas-epi/${o}/complete`);console.log("ğŸ” DEBUG Colaborador ID da ficha:",(a=(d=(e=i==null?void 0:i.data)==null?void 0:e.ficha)==null?void 0:d.colaborador)==null?void 0:a.id);const I=(g=(E=(s=i==null?void 0:i.data)==null?void 0:s.ficha)==null?void 0:E.colaborador)==null?void 0:g.id;console.log("ğŸ” DEBUG Colaborador ID para devoluÃ§Ãµes:",I);const[f,O]=await Promise.all([v.get(`/fichas-epi/${o}/entregas`),this.buscarDevolucoes(o,I)]);console.log("âœ… Dados da ficha carregados via endpoints especÃ­ficos"),console.log("ğŸ” DEBUG Entregas do backend:",(q=f==null?void 0:f.data)==null?void 0:q[0]),console.log("ğŸ” DEBUG Complete response:",{devolucoes:((y=(h=i==null?void 0:i.data)==null?void 0:h.devolucoes)==null?void 0:y.length)||0,devolucoesData:(m=i==null?void 0:i.data)==null?void 0:m.devolucoes,fullStructure:Object.keys((i==null?void 0:i.data)||{})});let b={};try{(await this.getEPIsDisponiveis()).forEach(l=>{l.tipoEpiId&&(b[l.tipoEpiId]={nomeEquipamento:l.nomeEquipamento,numeroCA:l.numeroCA,categoria:l.categoria})}),console.log("ğŸ” EPI Lookup criado:",Object.keys(b).length,"tipos EPI")}catch(n){console.warn("âš ï¸ Erro ao criar lookup de EPIs:",n)}if(f&&f.data&&Array.isArray(f.data)&&(i.data.entregas=f.data.map(n=>{var l,u,t,p;return console.log("ğŸ” DEBUG Entrega individual:",{id:n.id,status:n.status,itens:((l=n.itens)==null?void 0:l.length)||0,itemSample:(u=n.itens)==null?void 0:u[0],itemSampleFull:JSON.stringify((t=n.itens)==null?void 0:t[0],null,2)}),{id:n.id,numero:n.numero||n.id,dataEntrega:n.dataEntrega||n.createdAt,status:n.status||"PENDENTE_ASSINATURA",statusDisplay:{cor:n.status==="ASSINADA"||n.status==="assinada"?"green":"yellow",label:n.status==="ASSINADA"||n.status==="assinada"?"Assinado":"Pendente Assinatura"},acoes:n.status==="ASSINADA"||n.status==="assinada"?["imprimir"]:["assinar","cancelar"],itens:((p=n.itens)==null?void 0:p.map(c=>{var P;console.log("ğŸ” DEBUG Item raw:",JSON.stringify(c,null,2));const w=b[c.tipoEpiId],r=((P=c.estoqueItem)==null?void 0:P.tipoEpi)||c.tipoEpi||c.equipamento||w||c,B=c.estoqueItem||c;return console.log("ğŸ” DEBUG EPI Data (com lookup):",r),console.log("ğŸ” DEBUG Lookup result para",c.tipoEpiId,":",w),{id:c.id,nomeEquipamento:(r==null?void 0:r.nomeEquipamento)||(r==null?void 0:r.nome)||(r==null?void 0:r.nome_equipamento)||"Nome nÃ£o disponÃ­vel",numeroCA:(r==null?void 0:r.numeroCa)||(r==null?void 0:r.numeroCA)||(r==null?void 0:r.numero_ca)||(r==null?void 0:r.ca)||"N/A",categoria:(r==null?void 0:r.categoriaEpi)||(r==null?void 0:r.categoria)||(r==null?void 0:r.category)||"NÃ£o informado",quantidade:c.quantidade||c.quantidadeEntregue||1,status:c.status}}))||[]}})),console.log("ğŸ”„ Carregando devoluÃ§Ãµes via endpoint oficial..."),I){console.log("ğŸ”„ Buscando devoluÃ§Ãµes para colaborador:",I);try{const u=(await this.getDevolucoesByColaborador(I)).map(t=>({id:t.entregaId||t.id||`dev-${Date.now()}`,nomeEquipamento:t.tipoEpiNome||t.nomeEquipamento||"Nome nÃ£o disponÃ­vel",numeroCA:t.tipoEpiCodigo||t.numeroCA||"N/A",categoria:t.tipoEpiCategoria||t.categoria||"NÃ£o informado",quantidade:1,dataDevolucao:t.dataDevolucao||"Data nÃ£o disponÃ­vel",motivo:t.motivoDevolucao||t.motivo||"Motivo nÃ£o informado",motivoDisplay:t.motivoDevolucao||t.motivo||"Motivo nÃ£o informado",condicaoItem:t.condicaoItem||"BOM",observacoes:t.observacoes||"",status:"processada",podeProcessar:!1,podeCancelar:!1,entregaId:t.entregaId,numeroSerie:t.numeroSerie,dataEntrega:t.dataEntrega,tempoUso:t.diasUso||t.tempoUso||0,responsavel:t.responsavelNome||t.responsavel||"NÃ£o informado"}));i.data.devolucoes=u,console.log("âœ… DevoluÃ§Ãµes carregadas via endpoint oficial:",u.length),u.length>0&&console.log("ğŸ” Primeira devoluÃ§Ã£o formatada:",u[0])}catch(l){console.error("âŒ Erro ao carregar devoluÃ§Ãµes via endpoint:",l),i.data.devolucoes=[]}let n=0;if(console.log("ğŸ” DEBUG: Verificando itens devolvidos nas entregas..."),console.log("ğŸ” DEBUG: Total de entregas:",((A=i.data.entregas)==null?void 0:A.length)||0),(D=i.data.entregas)==null||D.forEach((l,u)=>{var t,p;console.log(`ğŸ” DEBUG: Entrega ${u} (${l.id}) tem ${((t=l.itens)==null?void 0:t.length)||0} itens`),(p=l.itens)==null||p.forEach((c,w)=>{console.log(`ğŸ” DEBUG: Item ${w} - status: "${c.status}"`),c.status==="DEVOLVIDO"&&(n++,console.log(`âœ… DEBUG: Item devolvido encontrado! Total: ${n}`))})}),console.log(`ğŸ“‹ DEBUG: Total de itens com status DEVOLVIDO: ${n}`),n>0){console.log("ğŸ’¡ PROBLEMA IDENTIFICADO: O endpoint /api/teste-devolucoes/historico-global retorna array vazio, mas existem devoluÃ§Ãµes nos dados das entregas"),console.log("ğŸ’¡ SOLUÃ‡ÃƒO: Extrair devoluÃ§Ãµes dos dados das entregas atÃ© o endpoint ser corrigido");const l=[];(C=i.data.entregas)==null||C.forEach(u=>{var t;(t=u.itens)==null||t.forEach(p=>{p.status==="DEVOLVIDO"&&l.push({id:`dev-${p.id}-${Date.now()}`,nomeEquipamento:p.nomeEquipamento,numeroCA:p.numeroCA,categoria:p.categoria,quantidade:p.quantidade||1,dataDevolucao:u.dataEntrega,motivo:"Motivo nÃ£o especificado",motivoDisplay:"Motivo nÃ£o especificado",condicaoItem:"BOM",observacoes:`Item devolvido da entrega ${u.numero}`,status:"processada",podeProcessar:!1,podeCancelar:!1,entregaId:u.id,numeroSerie:`SER-${p.id}`,dataEntrega:u.dataEntrega,tempoUso:0,responsavel:"Sistema"})})}),l.length>0&&i.data.devolucoes.length===0&&(i.data.devolucoes=l,console.log(`âœ… SOLUÃ‡ÃƒO APLICADA: ${l.length} devoluÃ§Ãµes extraÃ­das dos dados das entregas`))}else console.log("â„¹ï¸ Nenhum item com status DEVOLVIDO encontrado nas entregas")}else console.warn("âš ï¸ Colaborador ID nÃ£o encontrado, nÃ£o Ã© possÃ­vel carregar devoluÃ§Ãµes"),i.data.devolucoes=[];return console.log("ğŸ“Š Dados finais - Entregas:",((U=i.data.entregas)==null?void 0:U.length)||0),console.log("ğŸ“Š Dados finais - DevoluÃ§Ãµes:",((F=i.data.devolucoes)==null?void 0:F.length)||0),i}catch(i){throw console.error("âŒ Erro ao buscar dados da ficha:",i),i}}async getEquipamentosEmPosse(o){console.log("ğŸ“¦ FichaQueryAdapter: Buscando equipamentos em posse:",o);try{const e=await v.get(`/fichas-epi/colaborador/${o}/posse-atual`);return console.log("âœ… Equipamentos em posse carregados"),e}catch(e){throw console.error("âŒ Erro ao buscar equipamentos em posse:",e),e}}async getFichasList(o){console.log("ğŸ“‹ FichaQueryAdapter: Listando fichas com filtros:",o);try{const e=await v.get("/fichas-epi/list-enhanced",{params:o});return console.log("âœ… Lista de fichas carregada:",e.data.items.length,"itens"),e.data}catch(e){throw console.error("âŒ Erro ao listar fichas:",e),e}}async getFichaById(o){console.log("ğŸ“‹ FichaQueryAdapter: Busca simples da ficha:",o);try{const e=await v.get(`/fichas-epi/${o}`);return console.log("âœ… Ficha simples carregada (fallback)"),e}catch(e){throw console.error("âŒ Erro ao buscar ficha simples:",e),e}}async getEPIsDisponiveis(){console.log("ğŸ“¦ FichaQueryAdapter: Buscando EPIs disponÃ­veis via /estoque/itens...");try{const o=await v.get("/estoque/itens");console.log("âœ… EPIs obtidos via /estoque/itens:",o),console.log("âœ… EPIs disponÃ­veis - resposta raw:",o),console.log("ğŸ” Estrutura completa da resposta:",JSON.stringify(o,null,2));let e=[];if(o&&Array.isArray(o))e=o;else if(o&&o.data){if(Array.isArray(o.data))e=o.data;else if(o.data.items&&Array.isArray(o.data.items))e=o.data.items;else if(o.data.posicoes&&Array.isArray(o.data.posicoes))e=o.data.posicoes;else if(o.data.itens&&Array.isArray(o.data.itens))e=o.data.itens;else if(typeof o.data=="object"){const s=Object.values(o.data).find(E=>Array.isArray(E));s?e=s:(console.warn("âš ï¸ NÃ£o foi possÃ­vel encontrar array nos dados:",o.data),e=[])}}else o&&o.items&&Array.isArray(o.items)?e=o.items:(console.warn("âš ï¸ Formato de EPIs inesperado:",o),console.log("ğŸ” Estrutura da resposta:",Object.keys(o||{})),e=[]);const d=e.map(a=>{var A,D;console.log("ğŸ” Item original:",a);const s=a.tipoEpi||a,E=a.quantidade||a.saldoDisponivel||a.quantidadeAtual||s.quantidadeDisponivel||s.quantidade_disponivel||0,g=a.id||a.tipoEpiId||s.id,q=a.tipoEpiId||s.id||a.id,h=a.tipoEpiNome||s.nomeEquipamento||s.nome_equipamento||s.nome||s.equipment_name,y=a.tipoEpiCodigo||s.numeroCa||s.numeroCA||s.numero_ca||s.registroCA||s.registro_ca||s.ca_number||s.ca;if(!g||!h)return console.warn("âš ï¸ Item ignorado por falta de dados essenciais:",a),null;const m={id:g,estoqueItemId:g,episDisponivelId:g,tipoEpiId:q,posicaoEstoqueId:g,nomeEquipamento:h,numeroCA:y||"N/A",registroCA:y||"N/A",categoria:s.categoria||s.category||s.tipo||"NÃ£o informado",quantidadeDisponivel:E,disponivel:E>0,almoxarifado:a.almoxarifadoNome||((A=a.almoxarifado)==null?void 0:A.nome)||"Central",almoxarifadoId:a.almoxarifadoId||((D=a.almoxarifado)==null?void 0:D.id),situacao:a.situacao,saldoTotal:a.saldoTotal,saldoReservado:a.saldoReservado};return console.log("ğŸ¯ EPI processado:",{id:m.id,nome:m.nomeEquipamento,quantidade:m.quantidadeDisponivel,disponivel:m.disponivel}),m}).filter(Boolean).filter(a=>a.disponivel&&a.quantidadeDisponivel>0);return console.log("âœ… EPIs normalizados:",d.length),console.log("ğŸ“¦ Amostra de EPIs:",d.slice(0,2)),d}catch(o){throw console.error("âŒ Erro ao buscar EPIs disponÃ­veis:",o),o}}async getUsuarios(){console.log("ğŸ‘¥ FichaQueryAdapter: Buscando usuÃ¡rios...");try{const o=await v.get("/usuarios");if(console.log("âœ… UsuÃ¡rios carregados"),o&&Array.isArray(o))return o;if(o&&o.data&&Array.isArray(o.data))return o.data;if(o&&o.items&&Array.isArray(o.items))return console.log("ğŸ“Š UsuÃ¡rios vÃªm em formato paginado, extraindo items"),o.items;throw console.error("âŒ Formato de usuÃ¡rios inesperado:",o),new Error("Formato de resposta de usuÃ¡rios invÃ¡lido")}catch(o){throw console.error("âŒ Erro ao buscar usuÃ¡rios:",o),o}}async buscarDevolucoes(o,e){console.log("ğŸ”„ FichaQueryAdapter: Buscando devoluÃ§Ãµes via endpoint oficial");try{if(e&&e.match(/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/)){const d=await this.getDevolucoesByColaborador(e);return console.log("âœ… DevoluÃ§Ãµes encontradas via endpoint oficial:",d.length),d}else return console.log("âš ï¸ Colaborador ID invÃ¡lido para UUID:",e),[]}catch(d){return console.error("âŒ Erro ao buscar devoluÃ§Ãµes via endpoint oficial:",d),[]}}async getDevolucoesByColaborador(o){var d;if(console.log("ğŸ”„ FichaQueryAdapter: Buscando devoluÃ§Ãµes do colaborador:",o),!/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(o))return console.warn("âš ï¸ Colaborador ID nÃ£o Ã© um UUID vÃ¡lido:",o),[];try{const a=await v.get("/teste-devolucoes/historico-global",{params:{colaboradorId:o,limit:100}});console.log("âœ… Response do endpoint de devoluÃ§Ãµes:",a);let s=[];return a&&a.success&&a.data?(a.data.devolucoes&&Array.isArray(a.data.devolucoes)?(s=a.data.devolucoes,console.log("ğŸ“‹ DevoluÃ§Ãµes encontradas (formato padrÃ£o):",s.length)):Array.isArray(a.data)?(s=a.data,console.log("ğŸ“‹ DevoluÃ§Ãµes encontradas (formato direto):",s.length)):console.warn("âš ï¸ Resposta nÃ£o contÃ©m devoluÃ§Ãµes no formato esperado:",{hasSuccess:!!(a!=null&&a.success),hasData:!!(a!=null&&a.data),hasDevolucoes:!!((d=a==null?void 0:a.data)!=null&&d.devolucoes),isDataArray:Array.isArray(a==null?void 0:a.data),responseStructure:Object.keys(a||{}),dataStructure:Object.keys((a==null?void 0:a.data)||{})}),s.length>0&&console.log("ğŸ“‹ Estrutura da primeira devoluÃ§Ã£o:",s[0]),a.data.estatisticas&&console.log("ğŸ“Š EstatÃ­sticas:",a.data.estatisticas)):console.warn("âš ï¸ Resposta invÃ¡lida do endpoint:",{hasResponse:!!a,hasSuccess:!!(a!=null&&a.success),hasData:!!(a!=null&&a.data)}),s}catch(a){if(console.error("âŒ Erro ao buscar devoluÃ§Ãµes:",a),a.response&&(console.error("âŒ Status HTTP:",a.response.status),console.error("âŒ Dados da resposta:",a.response.data),a.response.status===400))return console.warn("âš ï¸ Erro de validaÃ§Ã£o 400 - retornando array vazio"),[];throw a}}async getFichasWithColaboradores(o){console.log("ğŸ“‹ FichaQueryAdapter: MÃ©todo transitÃ³rio - getFichasWithColaboradores");const e={page:o.page,limit:o.limit,search:o.searchTerm,empresa:o.empresaFilter,cargo:o.cargoFilter,status:o.statusFilter,vencimentoProximo:o.devolucaoPendente};try{const d=await this.getFichasList(e);return{fichas:d.items,total:d.pagination.total,page:d.pagination.page,pageSize:d.pagination.limit}}catch(d){throw console.error("âŒ Erro no mÃ©todo transitÃ³rio:",d),d}}}const L=new S;export{L as f};
